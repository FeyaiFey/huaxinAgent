以下是 `SQL Server` 设计，包含 **用户、角色、权限、部门管理**，支持 **前后端分离**，并实现 **精细化权限控制**。

------

### **1. 用户表（`huaxinAdmin_users`）**

存储用户基本信息，支持账号状态管理。

```sql
CREATE TABLE huaxinAdmin_users (
    id INT IDENTITY(1,1) PRIMARY KEY,  
    username NVARCHAR(50) NOT NULL UNIQUE,  
    password_hash NVARCHAR(255) NOT NULL,  
    email NVARCHAR(100) UNIQUE,  
    phone NVARCHAR(20) UNIQUE,  
    department_id INT NULL,  -- 关联部门  
    status TINYINT DEFAULT 1,  -- 1=正常, 0=禁用  
    created_at DATETIME DEFAULT GETDATE(),  
    updated_at DATETIME DEFAULT GETDATE(),  
    last_login DATETIME NULL,  

    CONSTRAINT FK_users_department FOREIGN KEY (department_id) REFERENCES huaxinAdmin_departments(id) ON DELETE SET NULL
);
```

------

### **2. 用户头像历史表（`huaxinAdmin_userAvatars`）**

支持用户头像变更历史，确保每个用户只有一个 `is_active=1` 的头像。

```sql
CREATE TABLE huaxinAdmin_userAvatars (
    id INT IDENTITY(1,1) PRIMARY KEY,  
    user_id INT NOT NULL,  
    avatar_url NVARCHAR(255) NOT NULL,  
    created_at DATETIME DEFAULT GETDATE(),  
    is_active BIT DEFAULT 1,  

    CONSTRAINT FK_userAvatars_users FOREIGN KEY (user_id) REFERENCES huaxinAdmin_users(id) ON DELETE CASCADE  
);

CREATE UNIQUE INDEX UX_userAvatars_active ON huaxinAdmin_userAvatars(user_id) WHERE is_active = 1;
```

------

### **3. 角色表（`huaxinAdmin_roles`）**

定义角色，如 **管理员、普通用户、财务等**。

```sql
CREATE TABLE huaxinAdmin_roles (
    id INT IDENTITY(1,1) PRIMARY KEY,  
    role_name NVARCHAR(50) NOT NULL UNIQUE,  
    description NVARCHAR(255) NULL,  
    created_at DATETIME DEFAULT GETDATE()  
);
```

------

### **4. 部门表（`huaxinAdmin_departments`）**

管理公司部门，支持层级关系。

```sql
CREATE TABLE huaxinAdmin_departments (
    id INT IDENTITY(1,1) PRIMARY KEY,  
    department_name NVARCHAR(100) NOT NULL UNIQUE,  
    parent_id INT NULL,  -- 允许子部门
    created_at DATETIME DEFAULT GETDATE(),  

    CONSTRAINT FK_departments_parent FOREIGN KEY (parent_id) REFERENCES huaxinAdmin_departments(id) ON DELETE SET NULL
);
```

------

### **5. 权限表（`huaxinAdmin_permissions`）**

存储 **精细权限**，例如 `user:create`、`user:edit`、`order:view`。

```sql
CREATE TABLE huaxinAdmin_permissions (
    id INT IDENTITY(1,1) PRIMARY KEY,  
    permission_key NVARCHAR(100) NOT NULL UNIQUE,  -- 例如 user:create  
    description NVARCHAR(255) NULL,  
    created_at DATETIME DEFAULT GETDATE()  
);
```

------

### **6. 用户-角色关联表（`huaxinAdmin_userRoles`）**

支持 **多角色绑定**，一个用户可以有多个角色。

```sql
CREATE TABLE huaxinAdmin_userRoles (
    id INT IDENTITY(1,1) PRIMARY KEY,  
    user_id INT NOT NULL,  
    role_id INT NOT NULL,  
    assigned_at DATETIME DEFAULT GETDATE(),  

    CONSTRAINT FK_userRoles_user FOREIGN KEY (user_id) REFERENCES huaxinAdmin_users(id) ON DELETE CASCADE,  
    CONSTRAINT FK_userRoles_role FOREIGN KEY (role_id) REFERENCES huaxinAdmin_roles(id) ON DELETE CASCADE,  

    UNIQUE (user_id, role_id)  
);
```

------

### **7. 角色-权限关联表（`huaxinAdmin_rolePermissions`）**

一个角色可拥有多个权限。

```sql
CREATE TABLE huaxinAdmin_rolePermissions (
    id INT IDENTITY(1,1) PRIMARY KEY,  
    role_id INT NOT NULL,  
    permission_id INT NOT NULL,  
    granted_at DATETIME DEFAULT GETDATE(),  

    CONSTRAINT FK_rolePermissions_role FOREIGN KEY (role_id) REFERENCES huaxinAdmin_roles(id) ON DELETE CASCADE,  
    CONSTRAINT FK_rolePermissions_permission FOREIGN KEY (permission_id) REFERENCES huaxinAdmin_permissions(id) ON DELETE CASCADE,  

    UNIQUE (role_id, permission_id)  
);
```

------

### **权限管理逻辑**

#### **1. 给用户分配角色**

```sql
INSERT INTO huaxinAdmin_userRoles (user_id, role_id) VALUES (1, 2);
```

#### **2. 给角色分配权限**

```sql
INSERT INTO huaxinAdmin_rolePermissions (role_id, permission_id) VALUES (2, 5);
```

#### **3. 查询用户的所有权限**

```sql
SELECT p.permission_key
FROM huaxinAdmin_userRoles ur
JOIN huaxinAdmin_rolePermissions rp ON ur.role_id = rp.role_id
JOIN huaxinAdmin_permissions p ON rp.permission_id = p.id
WHERE ur.user_id = 1;
```

------

### **设计优点**

✅ **支持用户多角色**（可赋予多个角色）
 ✅ **支持角色多权限**（精细化控制，如 `user:create`）
 ✅ **用户头像历史管理**（保存更换记录）
 ✅ **部门层级管理**（支持父子部门）
 ✅ **权限查询高效**（索引+关联查询）

------

这个设计符合你的权限管理需求吗？